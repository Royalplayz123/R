#!/bin/bash

# ================= CONFIG =================
REMOTE_HOST="tunnel.arain.cloud"
REMOTE_USER="root"
SSH_PORT="65535"

SERVICE_DIR="/etc/systemd/system"

# ================= COLORS =================
C_RESET='\033[0m'
C_RED='\033[0;31m'
C_GREEN='\033[0;32m'
C_YELLOW='\033[0;33m'
C_BLUE='\033[0;34m'
C_CYAN='\033[0;36m'
C_WHITE='\033[1;37m'

# ================= USAGE =================
usage() {
    echo -e "${C_WHITE}ArainCloud Tunnel Manager (MULTI)${C_RESET}"
    echo "------------------------------------------------"
    echo -e "${C_YELLOW}Usage:${C_RESET} tunnel <command>\n"

    echo -e "${C_CYAN}make <local_port> <remote_port>${C_RESET}"
    echo "    Create NEW persistent tunnel"

    echo -e "\n${C_CYAN}list${C_RESET}"
    echo "    List all tunnels"

    echo -e "\n${C_CYAN}kill <remote_port>${C_RESET}"
    echo "    Stop one tunnel"

    echo -e "\n${C_CYAN}killall${C_RESET}"
    echo "    Stop ALL tunnels"

    echo -e "\n${C_CYAN}help${C_RESET}"
    echo "    Show help"
    echo "------------------------------------------------"
}

# ================= ROOT CHECK =================
if [[ $EUID -ne 0 ]]; then
    echo -e "${C_RED}Run as root${C_RESET}"
    exit 1
fi

[ -z "$1" ] && usage && exit 0

# ================= COMMANDS =================
case "$1" in

make)
    LOCAL_PORT="$2"
    REMOTE_PORT="$3"

    [[ ! "$LOCAL_PORT" =~ ^[0-9]+$ ]] && echo "Invalid local port" && exit 1
    [[ ! "$REMOTE_PORT" =~ ^[0-9]+$ ]] && echo "Invalid remote port" && exit 1

    SERVICE_NAME="tunnel-${REMOTE_PORT}.service"
    SERVICE_FILE="${SERVICE_DIR}/${SERVICE_NAME}"

    if [[ -f "$SERVICE_FILE" ]]; then
        echo -e "${C_RED}Tunnel already exists for port ${REMOTE_PORT}${C_RESET}"
        exit 1
    fi

    echo -e "${C_BLUE}Creating tunnel ${REMOTE_PORT}...${C_RESET}"

    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=SSH Tunnel ${REMOTE_PORT}
After=network-online.target
Wants=network-online.target

[Service]
ExecStart=/usr/bin/ssh -N \
  -o ExitOnForwardFailure=yes \
  -o ServerAliveInterval=30 \
  -o ServerAliveCountMax=3 \
  -o StrictHostKeyChecking=no \
  -R ${REMOTE_PORT}:localhost:${LOCAL_PORT} \
  ${REMOTE_USER}@${REMOTE_HOST} -p ${SSH_PORT}
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable "$SERVICE_NAME"
    systemctl start "$SERVICE_NAME"

    echo -e "${C_GREEN}Tunnel created & persistent${C_RESET}"
    echo "Local  : $LOCAL_PORT"
    echo "Remote : ${REMOTE_HOST}:${REMOTE_PORT}"
;;

list)
    echo -e "${C_BLUE}Active tunnels:${C_RESET}\n"
    found=0
    for s in ${SERVICE_DIR}/tunnel-*.service; do
        [ -e "$s" ] || continue
        found=1
        name=$(basename "$s")
        port=${name#tunnel-}
        port=${port%.service}
        status=$(systemctl is-active "$name")
        echo -e "Remote ${C_CYAN}${port}${C_RESET} â†’ ${status}"
    done

    [[ $found -eq 0 ]] && echo -e "${C_YELLOW}No tunnels found${C_RESET}"
;;

kill)
    REMOTE_PORT="$2"
    SERVICE_NAME="tunnel-${REMOTE_PORT}.service"

    if [[ ! -f "${SERVICE_DIR}/${SERVICE_NAME}" ]]; then
        echo -e "${C_RED}Tunnel not found${C_RESET}"
        exit 1
    fi

    systemctl stop "$SERVICE_NAME"
    systemctl disable "$SERVICE_NAME"
    rm -f "${SERVICE_DIR}/${SERVICE_NAME}"
    systemctl daemon-reload

    echo -e "${C_GREEN}Tunnel ${REMOTE_PORT} removed${C_RESET}"
;;

killall)
    echo -e "${C_YELLOW}Removing ALL tunnels...${C_RESET}"
    for s in ${SERVICE_DIR}/tunnel-*.service; do
        [ -e "$s" ] || continue
        systemctl stop "$(basename "$s")"
        systemctl disable "$(basename "$s")"
        rm -f "$s"
    done
    systemctl daemon-reload
    echo -e "${C_GREEN}All tunnels removed${C_RESET}"
;;

help|*)
    usage
;;
esac
